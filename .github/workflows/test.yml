name: Tests

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]

  # Allow other workflows to call this one as a reusable workflow
  workflow_call:
    outputs:
      result:
        description: "Test outcome: success or failure"
        value: ${{ jobs.summarize.outputs.result }}

# Skip runs triggered only by non-code commits
# Docs/style/chore commits on branches (not tags) skip the test suite
concurrency:
  group: test-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ─── Guard: skip docs/style/chore-only pushes ────────────────────────────
  check-commit:
    name: Check commit message
    runs-on: ubuntu-latest
    outputs:
      skip: ${{ steps.filter.outputs.skip }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect skip-worthy commit messages
        id: filter
        run: |
          # On a tag push, always run tests
          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            echo "skip=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Collect commit messages in this push
          MESSAGES=$(git log --format="%s" HEAD~1..HEAD 2>/dev/null || git log --format="%s" -1)
          echo "Commit messages:"
          echo "$MESSAGES"

          # Skip patterns: docs: style: chore: ci: build: (but NOT feat: fix: test: refactor: perf:)
          SKIP_PATTERN="^(docs|style|chore|ci|build)(\(.+\))?(!)?:"
          TOTAL=$(echo "$MESSAGES" | wc -l)
          SKIP_COUNT=$(echo "$MESSAGES" | grep -cE "$SKIP_PATTERN" || true)

          if [ "$SKIP_COUNT" -eq "$TOTAL" ] && [ "$TOTAL" -gt 0 ]; then
            echo "⏭️ All commits match skip pattern — skipping tests"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "✅ Running tests"
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

  # ─── Unit Tests ─────────────────────────────────────────────────────────────
  unit:
    name: Unit Tests (Python ${{ matrix.python-version }} / ${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: check-commit
    if: needs.check-commit.outputs.skip != 'true'
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12"]
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov
          pip install -e .

      - name: Run unit tests with coverage
        run: |
          pytest tests/test_unit.py -v \
            --cov=nanodns \
            --cov-report=term-missing \
            --cov-report=xml:coverage-${{ matrix.os }}-${{ matrix.python-version }}.xml \
            --cov-fail-under=85

      - name: Upload coverage artifact
        if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.12'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage-*.xml
          retention-days: 7

  # ─── Integration Tests ─────────────────────────────────────────────────────
  integration:
    name: Integration Tests (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    needs: check-commit
    if: needs.check-commit.outputs.skip != 'true'
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.12"]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip

      - name: Install dependencies
        run: |
          pip install pytest pytest-asyncio
          pip install -e .

      - name: Run integration tests
        run: pytest tests/test_integration.py -v --tb=short

  # ─── Summarize ──────────────────────────────────────────────────────────────
  summarize:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [unit, integration]
    if: always()
    outputs:
      result: ${{ steps.outcome.outputs.result }}

    steps:
      - name: Evaluate outcomes
        id: outcome
        run: |
          UNIT="${{ needs.unit.result }}"
          INTG="${{ needs.integration.result }}"
          echo "unit=$UNIT integration=$INTG"

          if [[ "$UNIT" == "success" && "$INTG" == "success" ]]; then
            echo "result=success" >> $GITHUB_OUTPUT
            STATUS="✅ All tests passed"
          elif [[ "$UNIT" == "skipped" && "$INTG" == "skipped" ]]; then
            echo "result=skipped" >> $GITHUB_OUTPUT
            STATUS="⏭️ Tests skipped (docs/style/chore commit)"
          else
            echo "result=failure" >> $GITHUB_OUTPUT
            STATUS="❌ Tests failed"
          fi

          echo "### $STATUS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | $UNIT |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration Tests | $INTG |" >> $GITHUB_STEP_SUMMARY

      - name: Fail if tests failed
        if: steps.outcome.outputs.result == 'failure'
        run: exit 1
